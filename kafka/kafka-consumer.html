<!DOCTYPE html>
<html lang="en-US">
  <head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width,initial-scale=1">
    <title>Kafka 消费者 | BIGDATA-TUTORIAL</title>
    <meta name="generator" content="VuePress 1.5.2">
    <link rel="icon" href="/bigdata-tutorial/favicon.ico">
    <meta name="description" content="大数据教程">
    <link rel="preload" href="/bigdata-tutorial/assets/css/0.styles.9b6772c9.css" as="style"><link rel="preload" href="/bigdata-tutorial/assets/js/app.9e86c55f.js" as="script"><link rel="preload" href="/bigdata-tutorial/assets/js/4.6e5a58a7.js" as="script"><link rel="preload" href="/bigdata-tutorial/assets/js/31.3a150281.js" as="script"><link rel="preload" href="/bigdata-tutorial/assets/js/5.97e60065.js" as="script"><link rel="prefetch" href="/bigdata-tutorial/assets/js/10.b18536f5.js"><link rel="prefetch" href="/bigdata-tutorial/assets/js/11.d45305ad.js"><link rel="prefetch" href="/bigdata-tutorial/assets/js/12.f7ba974a.js"><link rel="prefetch" href="/bigdata-tutorial/assets/js/13.3fb367cb.js"><link rel="prefetch" href="/bigdata-tutorial/assets/js/14.f9ba6e81.js"><link rel="prefetch" href="/bigdata-tutorial/assets/js/15.92fa8d15.js"><link rel="prefetch" href="/bigdata-tutorial/assets/js/16.03a706f1.js"><link rel="prefetch" href="/bigdata-tutorial/assets/js/17.4240ccc4.js"><link rel="prefetch" href="/bigdata-tutorial/assets/js/18.47724a3c.js"><link rel="prefetch" href="/bigdata-tutorial/assets/js/19.893cd0e1.js"><link rel="prefetch" href="/bigdata-tutorial/assets/js/20.0f9c85d2.js"><link rel="prefetch" href="/bigdata-tutorial/assets/js/21.acc7f149.js"><link rel="prefetch" href="/bigdata-tutorial/assets/js/22.661a4c0a.js"><link rel="prefetch" href="/bigdata-tutorial/assets/js/23.81ddc809.js"><link rel="prefetch" href="/bigdata-tutorial/assets/js/24.86cf02b7.js"><link rel="prefetch" href="/bigdata-tutorial/assets/js/25.1a925ec5.js"><link rel="prefetch" href="/bigdata-tutorial/assets/js/26.44a7e88b.js"><link rel="prefetch" href="/bigdata-tutorial/assets/js/27.02160541.js"><link rel="prefetch" href="/bigdata-tutorial/assets/js/28.f81d3aba.js"><link rel="prefetch" href="/bigdata-tutorial/assets/js/29.e3c8d4f1.js"><link rel="prefetch" href="/bigdata-tutorial/assets/js/30.dea331c0.js"><link rel="prefetch" href="/bigdata-tutorial/assets/js/32.8d690ba0.js"><link rel="prefetch" href="/bigdata-tutorial/assets/js/33.1f32bcf1.js"><link rel="prefetch" href="/bigdata-tutorial/assets/js/34.45338a6d.js"><link rel="prefetch" href="/bigdata-tutorial/assets/js/35.e505a47e.js"><link rel="prefetch" href="/bigdata-tutorial/assets/js/36.5751c2c9.js"><link rel="prefetch" href="/bigdata-tutorial/assets/js/37.1270bfe7.js"><link rel="prefetch" href="/bigdata-tutorial/assets/js/38.3b5d01fa.js"><link rel="prefetch" href="/bigdata-tutorial/assets/js/39.f8cf867c.js"><link rel="prefetch" href="/bigdata-tutorial/assets/js/40.9f18e62f.js"><link rel="prefetch" href="/bigdata-tutorial/assets/js/41.10eace07.js"><link rel="prefetch" href="/bigdata-tutorial/assets/js/42.fd96f2b1.js"><link rel="prefetch" href="/bigdata-tutorial/assets/js/43.d77fd497.js"><link rel="prefetch" href="/bigdata-tutorial/assets/js/44.50436166.js"><link rel="prefetch" href="/bigdata-tutorial/assets/js/45.9f6de474.js"><link rel="prefetch" href="/bigdata-tutorial/assets/js/46.65d98cbf.js"><link rel="prefetch" href="/bigdata-tutorial/assets/js/47.8c2d3205.js"><link rel="prefetch" href="/bigdata-tutorial/assets/js/6.dd9aa758.js"><link rel="prefetch" href="/bigdata-tutorial/assets/js/7.ac8df731.js"><link rel="prefetch" href="/bigdata-tutorial/assets/js/8.83a9d945.js"><link rel="prefetch" href="/bigdata-tutorial/assets/js/9.c01c4b35.js"><link rel="prefetch" href="/bigdata-tutorial/assets/js/vendors~flowchart.8982e116.js"><link rel="prefetch" href="/bigdata-tutorial/assets/js/vendors~notification.f509967c.js">
    <link rel="stylesheet" href="/bigdata-tutorial/assets/css/0.styles.9b6772c9.css">
  </head>
  <body>
    <div id="app" data-server-rendered="true"><div class="theme-container"><header class="navbar"><div class="sidebar-button"><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" role="img" viewBox="0 0 448 512" class="icon"><path fill="currentColor" d="M436 124H12c-6.627 0-12-5.373-12-12V80c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12zm0 160H12c-6.627 0-12-5.373-12-12v-32c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12zm0 160H12c-6.627 0-12-5.373-12-12v-32c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12z"></path></svg></div> <a href="/bigdata-tutorial/" class="home-link router-link-active"><img src="images/dunwu-logo-100.png" alt="BIGDATA-TUTORIAL" class="logo"> <span class="site-name can-hide">BIGDATA-TUTORIAL</span></a> <div class="links"><div class="search-box"><input aria-label="Search" autocomplete="off" spellcheck="false" value=""> <!----></div> <nav class="nav-links can-hide"><div class="nav-item"><a href="/bigdata-tutorial/hive/" class="nav-link">
  Hive
</a></div><div class="nav-item"><a href="/bigdata-tutorial/hdfs/" class="nav-link">
  Hdfs
</a></div><div class="nav-item"><a href="/bigdata-tutorial/hbase/" class="nav-link">
  Hbase
</a></div><div class="nav-item"><a href="/bigdata-tutorial/zookeeper/" class="nav-link">
  ZooKeeper
</a></div><div class="nav-item"><a href="/bigdata-tutorial/kafka/" class="nav-link router-link-active">
  Kafka
</a></div><div class="nav-item"><div class="dropdown-wrapper"><button type="button" aria-label="Java" class="dropdown-title"><span class="title">✨ Java系列</span> <span class="arrow right"></span></button> <ul class="nav-dropdown" style="display:none;"><li class="dropdown-item"><!----> <a href="https://dunwu.github.io/java-tutorial/" target="_blank" rel="noopener noreferrer" class="nav-link external">
  Java 教程 📚
  <svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a></li><li class="dropdown-item"><!----> <a href="https://dunwu.github.io/bigdata-tutorial/" target="_blank" rel="noopener noreferrer" class="nav-link external">
  JavaCore 教程 📚
  <svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a></li><li class="dropdown-item"><!----> <a href="https://dunwu.github.io/bigdata-tutorial/" target="_blank" rel="noopener noreferrer" class="nav-link external">
  JavaTech 教程 📚
  <svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a></li><li class="dropdown-item"><!----> <a href="https://dunwu.github.io/spring-tutorial/" target="_blank" rel="noopener noreferrer" class="nav-link external">
  Spring 教程 📚
  <svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a></li><li class="dropdown-item"><!----> <a href="https://dunwu.github.io/spring-boot-tutorial/" target="_blank" rel="noopener noreferrer" class="nav-link external">
  Spring Boot 教程 📚
  <svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a></li></ul></div></div><div class="nav-item"><a href="https://github.com/dunwu/blog" target="_blank" rel="noopener noreferrer" class="nav-link external">
  🎯 博客
  <svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a></div> <a href="https://github.com/dunwu/bigdata-tutorial" target="_blank" rel="noopener noreferrer" class="repo-link">
    Github
    <svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a></nav></div></header> <div class="sidebar-mask"></div> <aside class="sidebar"><nav class="nav-links"><div class="nav-item"><a href="/bigdata-tutorial/hive/" class="nav-link">
  Hive
</a></div><div class="nav-item"><a href="/bigdata-tutorial/hdfs/" class="nav-link">
  Hdfs
</a></div><div class="nav-item"><a href="/bigdata-tutorial/hbase/" class="nav-link">
  Hbase
</a></div><div class="nav-item"><a href="/bigdata-tutorial/zookeeper/" class="nav-link">
  ZooKeeper
</a></div><div class="nav-item"><a href="/bigdata-tutorial/kafka/" class="nav-link router-link-active">
  Kafka
</a></div><div class="nav-item"><div class="dropdown-wrapper"><button type="button" aria-label="Java" class="dropdown-title"><span class="title">✨ Java系列</span> <span class="arrow right"></span></button> <ul class="nav-dropdown" style="display:none;"><li class="dropdown-item"><!----> <a href="https://dunwu.github.io/java-tutorial/" target="_blank" rel="noopener noreferrer" class="nav-link external">
  Java 教程 📚
  <svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a></li><li class="dropdown-item"><!----> <a href="https://dunwu.github.io/bigdata-tutorial/" target="_blank" rel="noopener noreferrer" class="nav-link external">
  JavaCore 教程 📚
  <svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a></li><li class="dropdown-item"><!----> <a href="https://dunwu.github.io/bigdata-tutorial/" target="_blank" rel="noopener noreferrer" class="nav-link external">
  JavaTech 教程 📚
  <svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a></li><li class="dropdown-item"><!----> <a href="https://dunwu.github.io/spring-tutorial/" target="_blank" rel="noopener noreferrer" class="nav-link external">
  Spring 教程 📚
  <svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a></li><li class="dropdown-item"><!----> <a href="https://dunwu.github.io/spring-boot-tutorial/" target="_blank" rel="noopener noreferrer" class="nav-link external">
  Spring Boot 教程 📚
  <svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a></li></ul></div></div><div class="nav-item"><a href="https://github.com/dunwu/blog" target="_blank" rel="noopener noreferrer" class="nav-link external">
  🎯 博客
  <svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a></div> <a href="https://github.com/dunwu/bigdata-tutorial" target="_blank" rel="noopener noreferrer" class="repo-link">
    Github
    <svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a></nav>  <ul class="sidebar-links"><li><section class="sidebar-group depth-0"><p class="sidebar-heading open"><span>Kafka 消费者</span> <!----></p> <ul class="sidebar-links sidebar-group-items"><li><a href="/bigdata-tutorial/kafka/kafka-consumer.html#一、消费者简介" class="sidebar-link">一、消费者简介</a><ul class="sidebar-sub-headers"><li class="sidebar-sub-header"><a href="/bigdata-tutorial/kafka/kafka-consumer.html#消费者" class="sidebar-link">消费者</a></li><li class="sidebar-sub-header"><a href="/bigdata-tutorial/kafka/kafka-consumer.html#消费者群组" class="sidebar-link">消费者群组</a></li><li class="sidebar-sub-header"><a href="/bigdata-tutorial/kafka/kafka-consumer.html#分区再均衡" class="sidebar-link">分区再均衡</a></li><li class="sidebar-sub-header"><a href="/bigdata-tutorial/kafka/kafka-consumer.html#轮询获取消息" class="sidebar-link">轮询获取消息</a></li></ul></li><li><a href="/bigdata-tutorial/kafka/kafka-consumer.html#二、消费者-api" class="sidebar-link">二、消费者 API</a><ul class="sidebar-sub-headers"><li class="sidebar-sub-header"><a href="/bigdata-tutorial/kafka/kafka-consumer.html#创建消费者" class="sidebar-link">创建消费者</a></li><li class="sidebar-sub-header"><a href="/bigdata-tutorial/kafka/kafka-consumer.html#订阅主题" class="sidebar-link">订阅主题</a></li><li class="sidebar-sub-header"><a href="/bigdata-tutorial/kafka/kafka-consumer.html#轮询" class="sidebar-link">轮询</a></li></ul></li><li><a href="/bigdata-tutorial/kafka/kafka-consumer.html#三、提交偏移量" class="sidebar-link">三、提交偏移量</a><ul class="sidebar-sub-headers"><li class="sidebar-sub-header"><a href="/bigdata-tutorial/kafka/kafka-consumer.html#提交偏移量的旧方案" class="sidebar-link">提交偏移量的旧方案</a></li><li class="sidebar-sub-header"><a href="/bigdata-tutorial/kafka/kafka-consumer.html#提交偏移量的新方案" class="sidebar-link">提交偏移量的新方案</a></li><li class="sidebar-sub-header"><a href="/bigdata-tutorial/kafka/kafka-consumer.html#自动提交" class="sidebar-link">自动提交</a></li><li class="sidebar-sub-header"><a href="/bigdata-tutorial/kafka/kafka-consumer.html#手动提交" class="sidebar-link">手动提交</a></li></ul></li><li><a href="/bigdata-tutorial/kafka/kafka-consumer.html#五、如何退出" class="sidebar-link">五、如何退出</a><ul class="sidebar-sub-headers"></ul></li><li><a href="/bigdata-tutorial/kafka/kafka-consumer.html#六、反序列化器" class="sidebar-link">六、反序列化器</a><ul class="sidebar-sub-headers"></ul></li><li><a href="/bigdata-tutorial/kafka/kafka-consumer.html#七、独立消费者" class="sidebar-link">七、独立消费者</a><ul class="sidebar-sub-headers"></ul></li><li><a href="/bigdata-tutorial/kafka/kafka-consumer.html#八、消费者的配置" class="sidebar-link">八、消费者的配置</a><ul class="sidebar-sub-headers"></ul></li><li><a href="/bigdata-tutorial/kafka/kafka-consumer.html#参考资料" class="sidebar-link">参考资料</a><ul class="sidebar-sub-headers"></ul></li></ul></section></li></ul> </aside> <main class="page"> <div class="theme-default-content content__default"><h1 id="kafka-消费者"><a href="#kafka-消费者" class="header-anchor">#</a> Kafka 消费者</h1> <ul><li><a href="#%E4%B8%80%E6%B6%88%E8%B4%B9%E8%80%85%E7%AE%80%E4%BB%8B">一、消费者简介</a> <ul><li><a href="#%E6%B6%88%E8%B4%B9%E8%80%85">消费者</a></li> <li><a href="#%E6%B6%88%E8%B4%B9%E8%80%85%E7%BE%A4%E7%BB%84">消费者群组</a></li> <li><a href="#%E5%88%86%E5%8C%BA%E5%86%8D%E5%9D%87%E8%A1%A1">分区再均衡</a></li> <li><a href="#%E8%BD%AE%E8%AF%A2%E8%8E%B7%E5%8F%96%E6%B6%88%E6%81%AF">轮询获取消息</a></li></ul></li> <li><a href="#%E4%BA%8C%E6%B6%88%E8%B4%B9%E8%80%85-api">二、消费者 API</a> <ul><li><a href="#%E5%88%9B%E5%BB%BA%E6%B6%88%E8%B4%B9%E8%80%85">创建消费者</a></li> <li><a href="#%E8%AE%A2%E9%98%85%E4%B8%BB%E9%A2%98">订阅主题</a></li> <li><a href="#%E8%BD%AE%E8%AF%A2">轮询</a></li></ul></li> <li><a href="#%E4%B8%89%E6%8F%90%E4%BA%A4%E5%81%8F%E7%A7%BB%E9%87%8F">三、提交偏移量</a> <ul><li><a href="#%E6%8F%90%E4%BA%A4%E5%81%8F%E7%A7%BB%E9%87%8F%E7%9A%84%E6%97%A7%E6%96%B9%E6%A1%88">提交偏移量的旧方案</a></li> <li><a href="#%E6%8F%90%E4%BA%A4%E5%81%8F%E7%A7%BB%E9%87%8F%E7%9A%84%E6%96%B0%E6%96%B9%E6%A1%88">提交偏移量的新方案</a></li> <li><a href="#%E8%87%AA%E5%8A%A8%E6%8F%90%E4%BA%A4">自动提交</a></li> <li><a href="#%E6%89%8B%E5%8A%A8%E6%8F%90%E4%BA%A4">手动提交</a></li></ul></li> <li><a href="#%E4%BA%94%E5%A6%82%E4%BD%95%E9%80%80%E5%87%BA">五、如何退出</a></li> <li><a href="#%E5%85%AD%E5%8F%8D%E5%BA%8F%E5%88%97%E5%8C%96%E5%99%A8">六、反序列化器</a></li> <li><a href="#%E4%B8%83%E7%8B%AC%E7%AB%8B%E6%B6%88%E8%B4%B9%E8%80%85">七、独立消费者</a></li> <li><a href="#%E5%85%AB%E6%B6%88%E8%B4%B9%E8%80%85%E7%9A%84%E9%85%8D%E7%BD%AE">八、消费者的配置</a></li> <li><a href="#%E5%8F%82%E8%80%83%E8%B5%84%E6%96%99">参考资料</a></li></ul> <h2 id="一、消费者简介"><a href="#一、消费者简介" class="header-anchor">#</a> 一、消费者简介</h2> <h3 id="消费者"><a href="#消费者" class="header-anchor">#</a> 消费者</h3> <p>Kafka 消费者以 <strong>pull 方式</strong>从 broker 拉取消息，消费者可以订阅一个或多个主题，然后按照消息生成顺序（<strong>kafka 只能保证分区中消息的顺序</strong>）读取消息。</p> <p><strong>一个消息只有在所有跟随者节点都进行了同步，才会被消费者获取到</strong>。如下图，只能消费 Message0、Message1、Message2：</p> <p><img src="http://dunwu.test.upcdn.net/snap/20200621113917.png" alt="img"></p> <h3 id="消费者群组"><a href="#消费者群组" class="header-anchor">#</a> 消费者群组</h3> <p>Kafka 消费者从属于消费者群组，<strong>一个群组里的 Consumer 订阅同一个 Topic，一个主题有多个 Partition，每一个 Partition 只能隶属于消费者群组中的一个 Consumer</strong>。</p> <ul><li>同一时刻，<strong>一条消息只能被同一消费者组中的一个消费者实例消费</strong>。</li> <li><strong>消费者群组之间互不影响</strong>。</li></ul> <p><img src="http://dunwu.test.upcdn.net/snap/20200621114128.png" alt="img"></p> <h3 id="分区再均衡"><a href="#分区再均衡" class="header-anchor">#</a> 分区再均衡</h3> <h3 id="轮询获取消息"><a href="#轮询获取消息" class="header-anchor">#</a> 轮询获取消息</h3> <p>Kafka 消费者通过 <code>poll</code> 来获取消息，但是获取消息时并不是立刻返回结果，需要考虑两个因素：</p> <ul><li>消费者通过 <code>customer.poll(time)</code> 中设置的等待时间</li> <li>broker 会等待累计一定量数据，然后发送给消费者。这样可以减少网络开销。</li></ul> <div align="center"><img src="http://upload-images.jianshu.io/upload_images/3101171-d7d111e7c7e7f504.png"></div> <p>poll 处了获取消息外，还有其他作用：</p> <ul><li><strong>发送心跳信息</strong>。消费者通过向被指派为群组协调器的 broker 发送心跳来维护他和群组的从属关系，当机器宕掉后，群组协调器触发再均衡。</li></ul> <h2 id="二、消费者-api"><a href="#二、消费者-api" class="header-anchor">#</a> 二、消费者 API</h2> <h3 id="创建消费者"><a href="#创建消费者" class="header-anchor">#</a> 创建消费者</h3> <div class="language-java extra-class"><pre class="language-java"><code><span class="token class-name">Properties</span> props <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Properties</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
props<span class="token punctuation">.</span><span class="token function">put</span><span class="token punctuation">(</span><span class="token class-name">ConsumerConfig</span><span class="token punctuation">.</span>BOOTSTRAP_SERVERS_CONFIG<span class="token punctuation">,</span> <span class="token string">&quot;localhost:9092&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
props<span class="token punctuation">.</span><span class="token function">put</span><span class="token punctuation">(</span><span class="token class-name">ConsumerConfig</span><span class="token punctuation">.</span>GROUP_ID_CONFIG<span class="token punctuation">,</span> <span class="token string">&quot;test&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
props<span class="token punctuation">.</span><span class="token function">put</span><span class="token punctuation">(</span><span class="token class-name">ConsumerConfig</span><span class="token punctuation">.</span>ENABLE_AUTO_COMMIT_CONFIG<span class="token punctuation">,</span> <span class="token string">&quot;false&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
props<span class="token punctuation">.</span><span class="token function">put</span><span class="token punctuation">(</span><span class="token class-name">ConsumerConfig</span><span class="token punctuation">.</span>KEY_DESERIALIZER_CLASS_CONFIG<span class="token punctuation">,</span>
          <span class="token string">&quot;org.apache.kafka.common.serialization.StringDeserializer&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
props<span class="token punctuation">.</span><span class="token function">put</span><span class="token punctuation">(</span><span class="token class-name">ConsumerConfig</span><span class="token punctuation">.</span>VALUE_DESERIALIZER_CLASS_CONFIG<span class="token punctuation">,</span>
          <span class="token string">&quot;org.apache.kafka.common.serialization.StringDeserializer&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token class-name">KafkaConsumer</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">String</span><span class="token punctuation">,</span> <span class="token class-name">String</span><span class="token punctuation">&gt;</span></span> consumer <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">KafkaConsumer</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token punctuation">&gt;</span></span><span class="token punctuation">(</span>props<span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre></div><h3 id="订阅主题"><a href="#订阅主题" class="header-anchor">#</a> 订阅主题</h3> <div class="language-java extra-class"><pre class="language-java"><code><span class="token comment">// 订阅主题列表</span>
consumer<span class="token punctuation">.</span><span class="token function">subscribe</span><span class="token punctuation">(</span><span class="token class-name">Arrays</span><span class="token punctuation">.</span><span class="token function">asList</span><span class="token punctuation">(</span><span class="token string">&quot;t1&quot;</span><span class="token punctuation">,</span> <span class="token string">&quot;t2&quot;</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token comment">// 订阅所有与 test 相关的主题</span>
consumer<span class="token punctuation">.</span><span class="token function">subscribe</span><span class="token punctuation">(</span><span class="token string">&quot;test.*&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre></div><h3 id="轮询"><a href="#轮询" class="header-anchor">#</a> 轮询</h3> <p>消息轮询是消费者 API 的核心。一旦消费者订阅了主题，轮询就会处理所有细节，包括：群组协调、分区再均衡、发送心跳和获取数据。</p> <div class="language-java extra-class"><pre class="language-java"><code><span class="token keyword">try</span> <span class="token punctuation">{</span>
    <span class="token comment">// 3. 轮询</span>
    <span class="token keyword">while</span> <span class="token punctuation">(</span><span class="token boolean">true</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token comment">// 4. 消费消息</span>
        <span class="token class-name">ConsumerRecords</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">String</span><span class="token punctuation">,</span> <span class="token class-name">String</span><span class="token punctuation">&gt;</span></span> records <span class="token operator">=</span> consumer<span class="token punctuation">.</span><span class="token function">poll</span><span class="token punctuation">(</span><span class="token class-name">Duration</span><span class="token punctuation">.</span><span class="token function">ofMillis</span><span class="token punctuation">(</span><span class="token number">100</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token class-name">ConsumerRecord</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">String</span><span class="token punctuation">,</span> <span class="token class-name">String</span><span class="token punctuation">&gt;</span></span> <span class="token keyword">record</span> <span class="token operator">:</span> records<span class="token punctuation">)</span> <span class="token punctuation">{</span>
            log<span class="token punctuation">.</span><span class="token function">debug</span><span class="token punctuation">(</span><span class="token string">&quot;topic = {}, partition = {}, offset = {}, key = {}, value = {}&quot;</span><span class="token punctuation">,</span>
                <span class="token keyword">record</span><span class="token punctuation">.</span><span class="token function">topic</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token keyword">record</span><span class="token punctuation">.</span><span class="token function">partition</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
                <span class="token keyword">record</span><span class="token punctuation">.</span><span class="token function">offset</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token keyword">record</span><span class="token punctuation">.</span><span class="token function">key</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token keyword">record</span><span class="token punctuation">.</span><span class="token function">value</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span> <span class="token keyword">finally</span> <span class="token punctuation">{</span>
    <span class="token comment">// 5. 退出程序前，关闭消费者</span>
    consumer<span class="token punctuation">.</span><span class="token function">close</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre></div><h2 id="三、提交偏移量"><a href="#三、提交偏移量" class="header-anchor">#</a> 三、提交偏移量</h2> <p><strong>更新分区当前位置的操作叫作提交</strong>。</p> <h3 id="提交偏移量的旧方案"><a href="#提交偏移量的旧方案" class="header-anchor">#</a> 提交偏移量的旧方案</h3> <p>老版本的 Consumer Group 把位移保存在 ZooKeeper 中。ZooKeeper 是一个分布式的协调服务框架，Kafka 重度依赖它实现各种各样的协调管理。将位移保存在 ZooKeeper 外部系统的做法，最显而易见的好处就是减少了 Kafka Broker 端的状态保存开销。</p> <p>ZooKeeper 这类元框架其实并不适合进行频繁的写更新，而 Consumer Group 的位移更新却是一个非常频繁的操作。这种大吞吐量的写操作会极大地拖慢 ZooKeeper 集群的性能，因此 Kafka 社区渐渐有了这样的共识：将 Consumer 位移保存在 ZooKeeper 中是不合适的做法。</p> <h3 id="提交偏移量的新方案"><a href="#提交偏移量的新方案" class="header-anchor">#</a> 提交偏移量的新方案</h3> <p>新版本 Consumer 的位移管理机制其实也很简单，就是**将 Consumer 的位移数据作为一条条普通的 Kafka 消息，提交到 **consumer_offsets 中。可以这么说，<strong>consumer_offsets 的主要作用是保存 Kafka 消费者的位移信息。</strong></p> <p><strong>位移主题的 Key 中应该保存 3 部分内容：<code>&lt;Group ID，主题名，分区号 &gt;</code></strong>。</p> <p>通常来说，<strong>当 Kafka 集群中的第一个 Consumer 程序启动时，Kafka 会自动创建位移主题</strong>。我们说过，位移主题就是普通的 Kafka 主题，那么它自然也有对应的分区数。但如果是 Kafka 自动创建的，分区数是怎么设置的呢？这就要看 Broker 端参数 <code>offsets.topic.num.partitions</code> 的取值了。它的默认值是 50，因此 Kafka 会自动创建一个 50 分区的位移主题。如果你曾经惊讶于 Kafka 日志路径下冒出很多 <code>__consumer_offsets-xxx</code> 这样的目录，那么现在应该明白了吧，这就是 Kafka 自动帮你创建的位移主题啊。</p> <p>你可能会问，除了分区数，副本数或备份因子是怎么控制的呢？答案也很简单，这就是 Broker 端另一个参数 offsets.topic.replication.factor 要做的事情了。它的默认值是 3。</p> <p>总结一下，<strong>如果位移主题是 Kafka 自动创建的，那么该主题的分区数是 50，副本数是 3</strong>。</p> <p>如果消费者一直处于运行状态，那么偏移量就没有什么用处。不过，如果消费者发生崩溃或有新的消费者加入群组，就会<strong>触发再均衡</strong>，完成再均衡后，每个消费者可能分配到新的分区，而不是之前处理的那个。为了能够继续之前的工作，消费者需要读取每个分区最后一次提交的偏移量，然后从偏移量指定的地方继续处理。</p> <p>（1）<strong>如果提交的偏移量小于客户端处理的最后一个消息的偏移量，那么处于两个偏移量之间的消息就会被重复处理</strong>。</p> <p><img src="http://dunwu.test.upcdn.net/snap/20200620162858.png" alt="img"></p> <p>（2）<strong>如果提交的偏移量大于客户端处理的最后一个消息的偏移量，那么处于两个偏移量之间的消息将会丢失</strong>。</p> <p><img src="http://dunwu.test.upcdn.net/snap/20200620162946.png" alt="img"></p> <p>由此可知，处理偏移量，会对客户端处理数据产生影响。</p> <h3 id="自动提交"><a href="#自动提交" class="header-anchor">#</a> 自动提交</h3> <p>自动提交是 Kafka 处理偏移量最简单的方式。</p> <p>当 <code>enable.auto.commit</code> 属性被设为 true，那么每过 <code>5s</code>，消费者会自动把从 <code>poll()</code> 方法接收到的最大偏移量提交上去。提交时间间隔由 <code>auto.commit.interval.ms</code> 控制，默认值是 <code>5s</code>。</p> <p>与消费者里的其他东西一样，<strong>自动提交也是在轮询里进行的</strong>。消费者每次在进行轮询时会检查是否该提交偏移量了，如果是，那么就会提交从上一次轮询返回的偏移量。</p> <p>假设我们仍然使用默认的 5s 提交时间间隔，在最近一次提交之后的 3s 发生了再均衡，再均衡之后，消费者从最后一次提交的偏移量位置开始读取消息。这个时候偏移量已经落后了 3s（因为没有达到 5s 的时限，并没有提交偏移量），所以在这 3s 的数据将会被重复处理。虽然可以通过修改提交时间间隔来更频繁地提交偏移量，减小可能出现重复消息的时间窗的时间跨度，不过这种情况是无法完全避免的。</p> <p>在使用自动提交时，每次调用轮询方法都会把上一次调用返回的偏移量提交上去，它并不知道具体哪些消息已经被处理了，所以在再次调用之前最好确保所有当前调用返回的消息都已经处理完毕（在调用 close() 方法之前也会进行自动提交）。一般情况下不会有什么问题，不过在处理异常或提前退出轮询时要格外小心。</p> <p><strong>自动提交虽然方便，不过无法避免重复消息问题</strong>。</p> <h3 id="手动提交"><a href="#手动提交" class="header-anchor">#</a> 手动提交</h3> <p>自动提交无法保证消息可靠性传输。</p> <p>因此，为了解决丢失消息的问题，可以通过手动提交偏移量。</p> <p>首先，<strong>把 <code>enable.auto.commit</code> 设为 false，关闭自动提交</strong>。</p> <h4 id="（1）同步提交"><a href="#（1）同步提交" class="header-anchor">#</a> （1）同步提交</h4> <p><strong>使用 <code>commitSync()</code> 提交偏移量最简单也最可靠</strong>。这个 API 会提交由 <code>poll()</code> 方法返回的最新偏移量，提交成功后马上返回，如果提交失败就抛出异常。</p> <div class="language-java extra-class"><pre class="language-java"><code><span class="token keyword">while</span> <span class="token punctuation">(</span><span class="token boolean">true</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token class-name">ConsumerRecords</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">String</span><span class="token punctuation">,</span> <span class="token class-name">String</span><span class="token punctuation">&gt;</span></span> records <span class="token operator">=</span> consumer<span class="token punctuation">.</span><span class="token function">poll</span><span class="token punctuation">(</span><span class="token number">100</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token class-name">ConsumerRecord</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">String</span><span class="token punctuation">,</span> <span class="token class-name">String</span><span class="token punctuation">&gt;</span></span> <span class="token keyword">record</span> <span class="token operator">:</span> records<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token class-name">System</span><span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">printf</span><span class="token punctuation">(</span><span class="token string">&quot;topic = %s, partition = %s, offset = %d, customer = %s, country = %s\n&quot;</span><span class="token punctuation">,</span>
            <span class="token keyword">record</span><span class="token punctuation">.</span><span class="token function">topic</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token keyword">record</span><span class="token punctuation">.</span><span class="token function">partition</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
            <span class="token keyword">record</span><span class="token punctuation">.</span><span class="token function">offset</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token keyword">record</span><span class="token punctuation">.</span><span class="token function">key</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token keyword">record</span><span class="token punctuation">.</span><span class="token function">value</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    <span class="token keyword">try</span> <span class="token punctuation">{</span>
        consumer<span class="token punctuation">.</span><span class="token function">commitSync</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span> <span class="token keyword">catch</span> <span class="token punctuation">(</span><span class="token class-name">CommitFailedException</span> e<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        log<span class="token punctuation">.</span><span class="token function">error</span><span class="token punctuation">(</span><span class="token string">&quot;commit failed&quot;</span><span class="token punctuation">,</span> e<span class="token punctuation">)</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre></div><p>同步提交的缺点：<strong>同步提交方式会一直阻塞，直到接收到 Broker 的响应请求，这会大大限制吞吐量</strong>。</p> <h4 id="（2）异步提交"><a href="#（2）异步提交" class="header-anchor">#</a> （2）异步提交</h4> <p><strong>在成功提交或碰到无法恢复的错误之前，<code>commitSync()</code> 会一直重试，但是 <code>commitAsync()</code> 不会</strong>，这也是 <code>commitAsync()</code> 不好的一个地方。<strong>它之所以不进行重试，是因为在它收到服务器响应的时候，可能有一个更大的偏移量已经提交成功</strong>。假设我们发出一个请求用于提交偏移量 2000，这个时候发生了短暂的通信问题，服务器收不到请求，自然也不会作出任何响应。与此同时，我们处理了另外一批消息，并成功提交了偏移量 3000。如果 <code>commitAsync()</code> 重新尝试提交偏移量 2000，它有可能在偏移量 3000 之后提交成功。这个时候<strong>如果发生再均衡，就会出现重复消息</strong>。</p> <div class="language-java extra-class"><pre class="language-java"><code><span class="token keyword">while</span> <span class="token punctuation">(</span><span class="token boolean">true</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token class-name">ConsumerRecords</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">String</span><span class="token punctuation">,</span> <span class="token class-name">String</span><span class="token punctuation">&gt;</span></span> records <span class="token operator">=</span> consumer<span class="token punctuation">.</span><span class="token function">poll</span><span class="token punctuation">(</span><span class="token class-name">Duration</span><span class="token punctuation">.</span><span class="token function">ofMillis</span><span class="token punctuation">(</span><span class="token number">100</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token class-name">ConsumerRecord</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">String</span><span class="token punctuation">,</span> <span class="token class-name">String</span><span class="token punctuation">&gt;</span></span> <span class="token keyword">record</span> <span class="token operator">:</span> records<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token class-name">System</span><span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">printf</span><span class="token punctuation">(</span><span class="token string">&quot;topic = %s, partition = %s, offset = % d, customer = %s, country = %s\n &quot;</span><span class="token punctuation">,</span>
            <span class="token keyword">record</span><span class="token punctuation">.</span><span class="token function">topic</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token keyword">record</span><span class="token punctuation">.</span><span class="token function">partition</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token keyword">record</span><span class="token punctuation">.</span><span class="token function">offset</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
            <span class="token keyword">record</span><span class="token punctuation">.</span><span class="token function">key</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token keyword">record</span><span class="token punctuation">.</span><span class="token function">value</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    consumer<span class="token punctuation">.</span><span class="token function">commitAsync</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre></div><p><strong><code>commitAsync()</code> 也支持回调</strong>，在 broker 作出响应时会执行回调。<strong>回调经常被用于记录提交错误或生成度量指标，不过如果要用它来进行重试，则一定要注意提交的顺序</strong>。</p> <div class="language-java extra-class"><pre class="language-java"><code><span class="token keyword">while</span> <span class="token punctuation">(</span><span class="token boolean">true</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token class-name">ConsumerRecords</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">String</span><span class="token punctuation">,</span> <span class="token class-name">String</span><span class="token punctuation">&gt;</span></span> records <span class="token operator">=</span> consumer<span class="token punctuation">.</span><span class="token function">poll</span><span class="token punctuation">(</span><span class="token class-name">Duration</span><span class="token punctuation">.</span><span class="token function">ofMillis</span><span class="token punctuation">(</span><span class="token number">100</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token class-name">ConsumerRecord</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">String</span><span class="token punctuation">,</span> <span class="token class-name">String</span><span class="token punctuation">&gt;</span></span> <span class="token keyword">record</span> <span class="token operator">:</span> records<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token class-name">System</span><span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">printf</span><span class="token punctuation">(</span><span class="token string">&quot;topic = %s, partition = %s, offset = % d, customer = %s, country = %s\n &quot;</span><span class="token punctuation">,</span>
            <span class="token keyword">record</span><span class="token punctuation">.</span><span class="token function">topic</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token keyword">record</span><span class="token punctuation">.</span><span class="token function">partition</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token keyword">record</span><span class="token punctuation">.</span><span class="token function">offset</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
            <span class="token keyword">record</span><span class="token punctuation">.</span><span class="token function">key</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token keyword">record</span><span class="token punctuation">.</span><span class="token function">value</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    consumer<span class="token punctuation">.</span><span class="token function">commitAsync</span><span class="token punctuation">(</span><span class="token keyword">new</span> <span class="token class-name">OffsetCommitCallback</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token annotation punctuation">@Override</span>
        <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">onComplete</span><span class="token punctuation">(</span><span class="token class-name">Map</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">TopicPartition</span><span class="token punctuation">,</span> <span class="token class-name">OffsetAndMetadata</span><span class="token punctuation">&gt;</span></span> offsets<span class="token punctuation">,</span> <span class="token class-name">Exception</span> e<span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token keyword">if</span> <span class="token punctuation">(</span>e <span class="token operator">!=</span> <span class="token keyword">null</span><span class="token punctuation">)</span> <span class="token punctuation">{</span> log<span class="token punctuation">.</span><span class="token function">error</span><span class="token punctuation">(</span><span class="token string">&quot;Commit failed for offsets {}&quot;</span><span class="token punctuation">,</span> offsets<span class="token punctuation">,</span> e<span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token punctuation">}</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre></div><blockquote><p><strong>重试异步提交</strong></p> <p>可以使用一个单调递增的序列号来维护异步提交的顺序。在每次提交偏移量之后或在回调里提交偏移量时递增序列号。在进行重试前，先检查回调的序列号和即将提交的偏移量是否相等，如果相等，说明没有新的提交，那么可以安全地进行重试；如果序列号比较大，说明有一个新的提交已经发送出去了，应该停止重试。</p></blockquote> <h4 id="（3）同步和异步组合提交"><a href="#（3）同步和异步组合提交" class="header-anchor">#</a> （3）同步和异步组合提交</h4> <p>一般情况下，针对偶尔出现的提交失败，不进行重试不会有太大问题，因为如果提交失败是因为临时问题导致的，那么后续的提交总会有成功的。但<strong>如果这是发生在关闭消费者或再均衡前的最后一次提交，就要确保能够提交成功</strong>。</p> <p>因此，在消费者关闭前一般会组合使用 <code>commitSync()</code> 和 <code>commitAsync()</code>。</p> <div class="language-java extra-class"><pre class="language-java"><code><span class="token keyword">try</span> <span class="token punctuation">{</span>
    <span class="token keyword">while</span> <span class="token punctuation">(</span><span class="token boolean">true</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token class-name">ConsumerRecords</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">String</span><span class="token punctuation">,</span> <span class="token class-name">String</span><span class="token punctuation">&gt;</span></span> records <span class="token operator">=</span> consumer<span class="token punctuation">.</span><span class="token function">poll</span><span class="token punctuation">(</span><span class="token class-name">Duration</span><span class="token punctuation">.</span><span class="token function">ofMillis</span><span class="token punctuation">(</span><span class="token number">100</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token class-name">ConsumerRecord</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">String</span><span class="token punctuation">,</span> <span class="token class-name">String</span><span class="token punctuation">&gt;</span></span> <span class="token keyword">record</span> <span class="token operator">:</span> records<span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token class-name">System</span><span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">printf</span><span class="token punctuation">(</span><span class="token string">&quot;topic = %s, partition = %s, offset = % d, customer = %s, country = %s\n &quot;</span><span class="token punctuation">,</span>
                <span class="token keyword">record</span><span class="token punctuation">.</span><span class="token function">topic</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token keyword">record</span><span class="token punctuation">.</span><span class="token function">partition</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token keyword">record</span><span class="token punctuation">.</span><span class="token function">offset</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token keyword">record</span><span class="token punctuation">.</span><span class="token function">key</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token keyword">record</span><span class="token punctuation">.</span><span class="token function">value</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
        consumer<span class="token punctuation">.</span><span class="token function">commitAsync</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span> <span class="token keyword">catch</span> <span class="token punctuation">(</span><span class="token class-name">Exception</span> e<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    log<span class="token punctuation">.</span><span class="token function">error</span><span class="token punctuation">(</span><span class="token string">&quot;Unexpected error&quot;</span><span class="token punctuation">,</span> e<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span> <span class="token keyword">finally</span> <span class="token punctuation">{</span>
    <span class="token keyword">try</span> <span class="token punctuation">{</span>
        consumer<span class="token punctuation">.</span><span class="token function">commitSync</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span> <span class="token keyword">finally</span> <span class="token punctuation">{</span>
        consumer<span class="token punctuation">.</span><span class="token function">close</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre></div><h4 id="（4）提交特定的偏移量"><a href="#（4）提交特定的偏移量" class="header-anchor">#</a> （4）提交特定的偏移量</h4> <p>提交偏移量的频率和处理消息批次的频率是一样的。如果想要更频繁地提交该怎么办？如果 <code>poll()</code> 方法返回一大批数据，为了避免因再均衡引起的重复处理整批消息，想要在批次中间提交偏移量该怎么办？这种情况无法通过调用 <code>commitSync()</code> 或 <code>commitAsync()</code> 来实现，因为它们只会提交最后一个偏移量，而此时该批次里的消息还没有处理完。</p> <p>解决办法是：<strong>消费者 API 允许在调用 <code>commitSync()</code> 和 <code>commitAsync()</code> 方法时传进去希望提交的分区和偏移量的 map</strong>。</p> <div class="language-java extra-class"><pre class="language-java"><code><span class="token keyword">private</span> <span class="token keyword">int</span> count <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>
<span class="token keyword">private</span> <span class="token keyword">final</span> <span class="token class-name">Map</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">TopicPartition</span><span class="token punctuation">,</span> <span class="token class-name">OffsetAndMetadata</span><span class="token punctuation">&gt;</span></span> currentOffsets <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">HashMap</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token punctuation">&gt;</span></span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>


<span class="token keyword">while</span> <span class="token punctuation">(</span><span class="token boolean">true</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token class-name">ConsumerRecords</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">String</span><span class="token punctuation">,</span> <span class="token class-name">String</span><span class="token punctuation">&gt;</span></span> records <span class="token operator">=</span> consumer<span class="token punctuation">.</span><span class="token function">poll</span><span class="token punctuation">(</span><span class="token number">100</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token class-name">ConsumerRecord</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">String</span><span class="token punctuation">,</span> <span class="token class-name">String</span><span class="token punctuation">&gt;</span></span> <span class="token keyword">record</span> <span class="token operator">:</span> records<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token class-name">System</span><span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">printf</span><span class="token punctuation">(</span><span class="token string">&quot;topic = %s, partition = %s, offset = % d, customer = %s, country = %s\n &quot;</span><span class="token punctuation">,</span>
                      <span class="token keyword">record</span><span class="token punctuation">.</span><span class="token function">topic</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token keyword">record</span><span class="token punctuation">.</span><span class="token function">partition</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token keyword">record</span><span class="token punctuation">.</span><span class="token function">offset</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token keyword">record</span><span class="token punctuation">.</span><span class="token function">key</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token keyword">record</span><span class="token punctuation">.</span><span class="token function">value</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

    currentOffsets<span class="token punctuation">.</span><span class="token function">put</span><span class="token punctuation">(</span><span class="token keyword">new</span> <span class="token class-name">TopicPartition</span><span class="token punctuation">(</span><span class="token keyword">record</span><span class="token punctuation">.</span><span class="token function">topic</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
                                          <span class="token keyword">record</span><span class="token punctuation">.</span><span class="token function">partition</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token keyword">new</span>
                       <span class="token class-name">OffsetAndMetadata</span><span class="token punctuation">(</span><span class="token keyword">record</span><span class="token punctuation">.</span><span class="token function">offset</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">+</span> <span class="token number">1</span><span class="token punctuation">,</span> <span class="token string">&quot;no metadata&quot;</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>count <span class="token operator">%</span> <span class="token number">1000</span> <span class="token operator">==</span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token punctuation">{</span> consumer<span class="token punctuation">.</span><span class="token function">commitAsync</span><span class="token punctuation">(</span>currentOffsets<span class="token punctuation">,</span> <span class="token keyword">null</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token punctuation">}</span>
    count<span class="token operator">++</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre></div><h4 id="（5）从特定偏移量处开始处理"><a href="#（5）从特定偏移量处开始处理" class="header-anchor">#</a> （5）从特定偏移量处开始处理</h4> <p>使用 <code>poll()</code> 方法可以从各个分区的最新偏移量处开始处理消息。</p> <p>不过，有时候，我们可能需要从特定偏移量处开始处理消息。</p> <ul><li>从分区的起始位置开始读消息：<code>seekToBeginning(Collection&lt;TopicPartition&gt; partitions)</code> 方法</li> <li>从分区的末尾位置开始读消息：<code>seekToEnd(Collection&lt;TopicPartition&gt; partitions)</code> 方法</li> <li>查找偏移量：<code>seek(TopicPartition partition, long offset)</code> 方法</li></ul> <p>通过 <code>seek(TopicPartition partition, long offset)</code> 可以实现处理消息和提交偏移量在一个事务中完成。思路就是需要在客户端建立一张数据表，保证处理消息和和消息偏移量位置写入到这张数据表。在一个事务中，此时就可以保证处理消息和记录偏移量要么同时成功，要么同时失败。</p> <div class="language-java extra-class"><pre class="language-java"><code>    consumer<span class="token punctuation">.</span><span class="token function">subscribe</span><span class="token punctuation">(</span>topic<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token comment">// 1.第一次调用pool,加入消费者群组</span>
    consumer<span class="token punctuation">.</span><span class="token function">poll</span><span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token comment">// 2.获取负责的分区，并从本地数据库读取改分区最新偏移量，并通过seek方法修改poll获取消息的位置</span>
    <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token class-name">TopicPartition</span> partition<span class="token operator">:</span> consumer<span class="token punctuation">.</span><span class="token function">assignment</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
        consumer<span class="token punctuation">.</span><span class="token function">seek</span><span class="token punctuation">(</span>partition<span class="token punctuation">,</span> <span class="token function">getOffsetFromDB</span><span class="token punctuation">(</span>partition<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token keyword">while</span> <span class="token punctuation">(</span><span class="token boolean">true</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token class-name">ConsumerRecords</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">String</span><span class="token punctuation">,</span> <span class="token class-name">String</span><span class="token punctuation">&gt;</span></span> records <span class="token operator">=</span>
        consumer<span class="token punctuation">.</span><span class="token function">poll</span><span class="token punctuation">(</span><span class="token number">100</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token class-name">ConsumerRecord</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">String</span><span class="token punctuation">,</span> <span class="token class-name">String</span><span class="token punctuation">&gt;</span></span> <span class="token keyword">record</span> <span class="token operator">:</span> records<span class="token punctuation">)</span>
        <span class="token punctuation">{</span>
            <span class="token function">processRecord</span><span class="token punctuation">(</span><span class="token keyword">record</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token function">storeRecordInDB</span><span class="token punctuation">(</span><span class="token keyword">record</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token function">storeOffsetInDB</span><span class="token punctuation">(</span><span class="token keyword">record</span><span class="token punctuation">.</span><span class="token function">topic</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token keyword">record</span><span class="token punctuation">.</span><span class="token function">partition</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
            <span class="token keyword">record</span><span class="token punctuation">.</span><span class="token function">offset</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
        <span class="token function">commitDBTransaction</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
</code></pre></div><h2 id="五、如何退出"><a href="#五、如何退出" class="header-anchor">#</a> 五、如何退出</h2> <p><strong>如果想让消费者从轮询消费消息的无限循环中退出，可以通过另一个线程调用 <code>consumer.wakeup()</code> 方法</strong>。 <strong><code>consumer.wakeup()</code> 是消费者唯一一个可以从其他线程里安全调用的方法</strong>。调用 <code>consumer.wakeup()</code> 可以退出 <code>poll()</code> ，并抛出 <code>WakeupException</code> 异常，或者如果调用 <code>consumer.wakeup()</code> 时线程没有等待轮询，那么异常将在下一轮调用 <code>poll()</code> 时抛出。</p> <div class="language-java extra-class"><pre class="language-java"><code><span class="token class-name">Runtime</span><span class="token punctuation">.</span><span class="token function">getRuntime</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">addShutdownHook</span><span class="token punctuation">(</span><span class="token keyword">new</span> <span class="token class-name">Thread</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">run</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token class-name">System</span><span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span><span class="token string">&quot;Starting exit...&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        consumer<span class="token punctuation">.</span><span class="token function">wakeup</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">try</span> <span class="token punctuation">{</span>
            mainThread<span class="token punctuation">.</span><span class="token function">join</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span> <span class="token keyword">catch</span> <span class="token punctuation">(</span><span class="token class-name">InterruptedException</span> e<span class="token punctuation">)</span> <span class="token punctuation">{</span>
            e<span class="token punctuation">.</span><span class="token function">printStackTrace</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>

<span class="token keyword">try</span> <span class="token punctuation">{</span>
    <span class="token comment">// looping until ctrl-c, the shutdown hook will cleanup on exit</span>
    <span class="token keyword">while</span> <span class="token punctuation">(</span><span class="token boolean">true</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token class-name">ConsumerRecords</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">String</span><span class="token punctuation">,</span> <span class="token class-name">String</span><span class="token punctuation">&gt;</span></span> records <span class="token operator">=</span>
            movingAvg<span class="token punctuation">.</span>consumer<span class="token punctuation">.</span><span class="token function">poll</span><span class="token punctuation">(</span><span class="token number">1000</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token class-name">System</span><span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span><span class="token class-name">System</span><span class="token punctuation">.</span><span class="token function">currentTimeMillis</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">+</span>
            <span class="token string">&quot;--  waiting for data...&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token class-name">ConsumerRecord</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">String</span><span class="token punctuation">,</span> <span class="token class-name">String</span><span class="token punctuation">&gt;</span></span> <span class="token keyword">record</span> <span class="token operator">:</span> records<span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token class-name">System</span><span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">printf</span><span class="token punctuation">(</span><span class="token string">&quot;offset = %d, key = %s, value = %s\n&quot;</span><span class="token punctuation">,</span>
                <span class="token keyword">record</span><span class="token punctuation">.</span><span class="token function">offset</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token keyword">record</span><span class="token punctuation">.</span><span class="token function">key</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token keyword">record</span><span class="token punctuation">.</span><span class="token function">value</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
        <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token class-name">TopicPartition</span> tp<span class="token operator">:</span> consumer<span class="token punctuation">.</span><span class="token function">assignment</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
            <span class="token class-name">System</span><span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span><span class="token string">&quot;Committing offset at position:&quot;</span> <span class="token operator">+</span>
                consumer<span class="token punctuation">.</span><span class="token function">position</span><span class="token punctuation">(</span>tp<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            movingAvg<span class="token punctuation">.</span>consumer<span class="token punctuation">.</span><span class="token function">commitSync</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span> <span class="token keyword">catch</span> <span class="token punctuation">(</span><span class="token class-name">WakeupException</span> e<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token comment">// ignore for shutdown</span>
<span class="token punctuation">}</span> <span class="token keyword">finally</span> <span class="token punctuation">{</span>
    consumer<span class="token punctuation">.</span><span class="token function">close</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token class-name">System</span><span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span><span class="token string">&quot;Closed consumer and we are done&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre></div><h2 id="六、反序列化器"><a href="#六、反序列化器" class="header-anchor">#</a> 六、反序列化器</h2> <p>生产者需要用<strong>序列化器</strong>将 Java 对象转换成字节数组再发送给 Kafka；同理，消费者需要用<strong>反序列化器</strong>将从 Kafka 接收到的字节数组转换成 Java 对象。</p> <h2 id="七、独立消费者"><a href="#七、独立消费者" class="header-anchor">#</a> 七、独立消费者</h2> <p>通常，会有多个 Kafka 消费者组成群组，关注一个主题。</p> <p>但可能存在这样的场景：只需要一个消费者从一个主题的所有分区或某个特定的分区读取数据。这时，就不需要消费者群组和再均衡了，只需要<strong>把主题或分区分配给消费者</strong>，然后开始读取消息并提交偏移量。</p> <p>如果是这样，就不需要订阅主题，取而代之的是为自己分配分区。一个消费者可以订阅主题（并加入消费者群组），或为自己分配分区，但不能同时做这两件事。</p> <div class="language-java extra-class"><pre class="language-java"><code><span class="token class-name">List</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">PartitionInfo</span><span class="token punctuation">&gt;</span></span> partitionInfos <span class="token operator">=</span> <span class="token keyword">null</span><span class="token punctuation">;</span>
partitionInfos <span class="token operator">=</span> consumer<span class="token punctuation">.</span><span class="token function">partitionsFor</span><span class="token punctuation">(</span><span class="token string">&quot;topic&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token keyword">if</span> <span class="token punctuation">(</span>partitionInfos <span class="token operator">!=</span> <span class="token keyword">null</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token class-name">PartitionInfo</span> partition <span class="token operator">:</span> partitionInfos<span class="token punctuation">)</span>
        partitions<span class="token punctuation">.</span><span class="token function">add</span><span class="token punctuation">(</span><span class="token keyword">new</span> <span class="token class-name">TopicPartition</span><span class="token punctuation">(</span>partition<span class="token punctuation">.</span><span class="token function">topic</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
            partition<span class="token punctuation">.</span><span class="token function">partition</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    consumer<span class="token punctuation">.</span><span class="token function">assign</span><span class="token punctuation">(</span>partitions<span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token keyword">while</span> <span class="token punctuation">(</span><span class="token boolean">true</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token class-name">ConsumerRecords</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">String</span><span class="token punctuation">,</span> <span class="token class-name">String</span><span class="token punctuation">&gt;</span></span> records <span class="token operator">=</span> consumer<span class="token punctuation">.</span><span class="token function">poll</span><span class="token punctuation">(</span><span class="token number">1000</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

        <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token class-name">ConsumerRecord</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">String</span><span class="token punctuation">,</span> <span class="token class-name">String</span><span class="token punctuation">&gt;</span></span> <span class="token keyword">record</span><span class="token operator">:</span> records<span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token class-name">System</span><span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">printf</span><span class="token punctuation">(</span>&quot;topic <span class="token operator">=</span> <span class="token operator">%</span>s<span class="token punctuation">,</span> partition <span class="token operator">=</span> <span class="token operator">%</span>s<span class="token punctuation">,</span> offset <span class="token operator">=</span> <span class="token operator">%</span>d<span class="token punctuation">,</span>
                customer <span class="token operator">=</span> <span class="token operator">%</span>s<span class="token punctuation">,</span> country <span class="token operator">=</span> <span class="token operator">%</span>s\n&quot;<span class="token punctuation">,</span>
                <span class="token keyword">record</span><span class="token punctuation">.</span><span class="token function">topic</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token keyword">record</span><span class="token punctuation">.</span><span class="token function">partition</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token keyword">record</span><span class="token punctuation">.</span><span class="token function">offset</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
                <span class="token keyword">record</span><span class="token punctuation">.</span><span class="token function">key</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token keyword">record</span><span class="token punctuation">.</span><span class="token function">value</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
        consumer<span class="token punctuation">.</span><span class="token function">commitSync</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre></div><h2 id="八、消费者的配置"><a href="#八、消费者的配置" class="header-anchor">#</a> 八、消费者的配置</h2> <ul><li><strong><code>bootstrap.servers</code></strong> - broker 集群地址，格式：ip1:port,ip2:port...，不需要设定全部的集群地址，设置两个或者两个以上即可。</li> <li><strong><code>group.id</code></strong> - 消费者隶属的消费者组名称，如果为空会报异常，一般而言，这个参数要有一定的业务意义。</li> <li><strong><code>fetch.min.bytes</code></strong> - 消费者获取记录的最小字节数。Kafka 会等到有足够的数据时才返回消息给消费者，以降低负载。</li> <li><strong><code>fetch.max.wait.ms</code></strong> - 用于指定 broker 的等待时间。</li> <li><strong><code>max.partition.fetch.bytes</code></strong> - 指定了服务器从每个分区返回给消费者的最大字节数。默认为 1 MB。</li> <li><strong><code>session.timeout.ms</code></strong> - 指定了消费的心跳超时时间。如果消费者没有在超时时间内发送心跳给群组协调器，协调器会视消费者已经消亡，从而触发再均衡。默认为 3 秒。</li> <li><strong><code>auto.offset.reset</code></strong> - 制定了消费者在读取一个没有偏移量的分区或偏移量无效的情况下，该如何处理。
<ul><li>latest，表示在偏移量无效时，消费者将从最新的记录开始读取分区记录。</li> <li>earliest，表示在偏移量无效时，消费者将从起始位置读取分区记录。</li></ul></li> <li><strong><code>enable.auto.commit</code></strong> - 指定了是否自动提交消息偏移量，默认开启。</li> <li><strong><code>partition.assignment.strategy</code></strong> - 消费者的分区分配策略。
<ul><li>Range，表示会将主题的若干个连续的分区分配给消费者。</li> <li>RoundRobin，表示会将主题的所有分区逐个分配给消费者。</li></ul></li> <li><strong><code>client.id</code></strong> - 客户端标识。</li> <li><strong><code>max.poll.records</code></strong> - 用于控制单次能获取到的记录数量。</li> <li><strong><code>receive.buffer.bytes</code></strong> - 用于设置 Socket 接收消息缓冲区（SO_RECBUF）的大小，默认值为 64KB。如果设置为-1，则使用操作系统的默认值。</li> <li><strong><code>send.buffer.bytes</code></strong> - 用于设置 Socket 发送消息缓冲区（SO_SNDBUF）的大小，默认值为 128KB。与 receive.buffer.bytes 参数一样，如果设置为-1，则使用操作系统的默认值。</li></ul> <h2 id="参考资料"><a href="#参考资料" class="header-anchor">#</a> 参考资料</h2> <ul><li><strong>官方</strong> <ul><li><a href="http://kafka.apache.org/" target="_blank" rel="noopener noreferrer">Kakfa 官网<svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a></li> <li><a href="https://github.com/apache/kafka" target="_blank" rel="noopener noreferrer">Kakfa Github<svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a></li> <li><a href="https://kafka.apache.org/documentation/" target="_blank" rel="noopener noreferrer">Kakfa 官方文档<svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a></li></ul></li> <li><strong>书籍</strong> <ul><li><a href="https://item.jd.com/12270295.html" target="_blank" rel="noopener noreferrer">《Kafka 权威指南》<svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a></li></ul></li> <li><strong>教程</strong> <ul><li><a href="https://github.com/apachecn/kafka-doc-zh" target="_blank" rel="noopener noreferrer">Kafka 中文文档<svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a></li> <li><a href="https://time.geekbang.org/column/intro/100029201" target="_blank" rel="noopener noreferrer">Kafka 核心技术与实战<svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a></li></ul></li></ul></div> <footer class="page-edit"><div class="edit-link"><a href="https://github.com/dunwu/bigdata-tutorial/edit/master/docs/kafka/kafka-consumer.md" target="_blank" rel="noopener noreferrer">帮助我们改善此页面！</a> <svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></div> <!----></footer> <!----> </main></div><div class="global-ui"><!----><!----></div></div>
    <script src="/bigdata-tutorial/assets/js/app.9e86c55f.js" defer></script><script src="/bigdata-tutorial/assets/js/4.6e5a58a7.js" defer></script><script src="/bigdata-tutorial/assets/js/31.3a150281.js" defer></script><script src="/bigdata-tutorial/assets/js/5.97e60065.js" defer></script>
  </body>
</html>
